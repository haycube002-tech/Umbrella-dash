<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Umbrella Dash Minimal Idle Start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {height:100%;margin:0;padding:0;background:#b3e5fc;overflow:hidden;width:100vw;user-select:none;touch-action:none;}
    body {text-align:center;width:100vw;}
    #canvas-wrap {position:fixed;top:0;left:0;width:100vw;height:100vh;margin:0;padding:0;}
    canvas {display:block;margin:0;padding:0;background:#fff;border:none;touch-action:none;width:100vw !important;height:100vh !important;z-index:10;position:absolute;left:0;top:0;}
    .controls-bar {position:fixed;left:0;right:0;bottom:0;width:100vw;height:19vh;z-index:15;display:flex;justify-content:center;align-items:flex-end;pointer-events:none;background:none;}
    .controls-inner {width:92vw;max-width:600px;height:100%;display:flex;flex-direction:row;align-items:flex-end;justify-content:space-between;margin:0 auto;pointer-events:none;position:relative;}
    .ctrl-btn {width:31vw;max-width:180px;min-width:68px;height:13vh;min-height:70px;display:flex;align-items:flex-end;justify-content:center;pointer-events:auto;margin-bottom:0;position:relative;background:none;z-index:1;}
    .ctrl-btn span {font-size:4em;background:rgba(25,118,210,0.22);border-radius:2.3em;padding:0.32em 1.2em;margin-bottom:1vh;color:#1976d2;border:2.5px solid #1976d2;box-shadow:0 2px 8px #1976d2a0;user-select:none;font-weight:900;transition:background 0.2s,color 0.2s,border 0.2s;display:flex;align-items:center;justify-content:center;}
    .ctrl-btn.active span,.ctrl-btn:active span {background:#1976d2;color:#fff;border:2.5px solid #0d47a1;}
    #ctrlBoost {width:20vw;max-width:120px;min-width:60px;height:10vh;min-height:50px;display:flex;align-items:flex-end;justify-content:center;pointer-events:auto;position:absolute;left:50%;bottom:1.2vh;transform:translateX(-50%);z-index:2;background:none;}
    #ctrlBoost span {font-size:2.4em;padding:0.08em 0.5em 0.1em 0.5em;border-radius:1.3em;background:#fff;border:2.5px solid #c62828;color:#c62828;box-shadow:0 2px 10px #c6282822;font-weight:900;display:flex;align-items:center;justify-content:center;transition:background 0.2s,color 0.2s,border 0.2s;}
    #ctrlBoost.active span,#ctrlBoost:active span {background:#c62828;color:#fff;border:2.5px solid #b71c1c;}
    #boost-indicator {width:100%;text-align:center;font-size:1.07em;pointer-events:none;z-index:25;opacity:0.97;display:none;background:#fff6;padding:0.13em 0;border-radius:1.2em 1.2em 0 0;color:#c62828;border:2px solid #c62828;font-weight:900;box-shadow:0 2px 8px #c6282820;letter-spacing:0.5px;min-width:90px;position:absolute;left:0;right:0;bottom:100%;margin:0 auto 0 auto;border-bottom:none;background-clip:padding-box;}
    #score-level {position:fixed;top:1.1em;left:0.5em;background:#e3f2fdcc;border-radius:0.78em;padding:0.25em 1.1em 0.24em 1.1em;color:#1565c0;font-size:1.09em;z-index:26;min-width:96px;text-align:left;box-shadow:0 2px 10px #90caf930;border:1.7px solid #1976d2;font-weight:650;letter-spacing:0.25px;pointer-events:none;}
    #umbrella-indicator {position:fixed;left:50%;top:3.1em;transform:translateX(-50%);font-size:2.2em;pointer-events:none;z-index:23;opacity:0.9;display:none;}
    #wetness-bar-outer {position:fixed;top:0.7em;right:0.5em;z-index:27;pointer-events:none;display:flex;flex-direction:column;align-items:flex-end;}
    #wetness-bar-container {background:#e3f2fdcc;border-radius:0.78em;box-shadow:0 2px 10px #90caf930;border:1.7px solid #1976d2;padding:0.5em 1em 0.4em 1em;min-width:130px;max-width:200px;display:flex;flex-direction:column;align-items:flex-end;}
    #wetness-bar-label {color:#1565c0;font-size:1.01em;font-weight:600;margin-bottom:0.23em;letter-spacing:0.2px;}
    #wetness-bar-bg {width:100px;height:15px;background:#fff;border:1.5px solid #1976d2;border-radius:7px;overflow:hidden;margin-bottom:0.2em;box-sizing:border-box;display:flex;align-items:center;}
    #wetness-bar-fill {height:100%;background:linear-gradient(90deg,#2196f3 0%,#1976d2 100%);border-radius:7px;transition:width 0.18s linear;}
    #btns {margin-top:0.23em;background:#e3f2fdcc;border-radius:0.5em;box-shadow:0 2px 10px #90caf930;border:1.3px solid #1976d2;padding:0.1em 0.7em 0.1em 0.7em;min-width:120px;width:fit-content;pointer-events:auto;display:flex;gap:0.7em;flex-direction:row;justify-content:flex-end;align-items:center;}
    .game-btn {font-size:1.08em;padding:0.32em 1.1em;border-radius:0.6em;border:none;color:#fff;background:#1976d2;font-weight:bold;cursor:pointer;box-shadow:0 2px 10px #0002;outline:none;pointer-events:auto;margin-top:0.1em;margin-bottom:0.1em;transition:background 0.2s;}
    .game-btn:active {background:#0d47a1;}
    #instructions {
      position:fixed;left:0;top:0;right:0;bottom:0;
      z-index:50;background:rgba(255,255,255,0.97);display:flex;align-items:center;justify-content:center;
      transition:opacity 0.3s;flex-direction:column;
    }
    #instructions-inner {
      max-width:410px;
      background:#e3f2fd;
      border-radius:1.2em;
      box-shadow:0 2px 16px #90caf94d;
      border:2.5px solid #1976d2;
      padding:2.2em 1.3em 2em 1.3em;
      margin-bottom:2em;
      display:flex;flex-direction:column;align-items:center;
    }
    #instructions-inner h2 {
      margin-top:0.1em;margin-bottom:0.6em;color:#1565c0;font-size:1.46em;letter-spacing:1px;text-shadow:0 2px 8px #fff8;font-weight:900;
    }
    #instructions-inner ul {
      text-align:left;margin:0.6em 0 0.3em 0.5em;padding-left:1.3em;color:#0d47a1;font-size:1.01em;line-height:1.7em;
    }
    #instructions-inner li {margin-bottom:0.12em;}
    #instructions-inner .tip {
      background:#fffde7;
      border-radius:0.7em;
      padding:0.48em 0.9em 0.48em 0.9em;
      color:#795548;
      margin-top:0.7em;
      font-size:1.01em;
      border-left:5px solid #ffd600;
      box-shadow:0 1px 6px #ffe08233;
      width:100%;text-align:left;
    }
    #startBtn {
      font-size:1.13em;
      padding:0.6em 2.2em;
      border-radius:0.8em;
      border:none;
      color:#fff;
      background:#1976d2;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 2px 10px #0002;
      outline:none;
      margin-top:1.1em;
      transition:background 0.18s;
      letter-spacing:1px;
    }
    #startBtn:active {background:#0d47a1;}
    @media (max-width:600px){
      .controls-inner{width:98vw;}.ctrl-btn{width:34vw;min-width:64px;}#ctrlBoost{width:30vw;min-width:50px;}#ctrlBoost span{font-size:1.6em;}.ctrl-btn span{font-size:2.6em;}#score-level{font-size:0.98em;}#wetness-bar-bg{width:78px;height:13px;}#wetness-bar-container{padding:0.4em 0.5em 0.3em 0.5em;min-width:90px;}#btns{padding:0.06em 0.3em 0.06em 0.3em;min-width:70px;}
    }
  </style>
</head>
<body>
  <div id="canvas-wrap"><canvas id="game"></canvas></div>
  <div class="controls-bar">
    <div class="controls-inner">
      <div id="ctrlLeft" class="ctrl-btn"><span>‚óÄÔ∏è</span></div>
      <div id="ctrlBoost"><div id="boost-indicator">‚ù§Ô∏è‚Äçü©π Boost!</div><span>‚ù§Ô∏è‚Äçü©π</span></div>
      <div id="ctrlRight" class="ctrl-btn"><span>‚ñ∂Ô∏è</span></div>
    </div>
  </div>
  <div id="score-level"></div>
  <div id="umbrella-indicator">‚òî</div>
  <div id="wetness-bar-outer">
    <div id="wetness-bar-container">
      <div id="wetness-bar-label">Wetness</div>
      <div id="wetness-bar-bg">
        <div id="wetness-bar-fill" style="width:0%"></div>
      </div>
    </div>
    <div id="btns">
      <button id="restartBtn" class="game-btn">Restart</button>
      <button id="pauseBtn" class="game-btn">Pause</button>
    </div>
  </div>
  <div id="instructions">
    <div id="instructions-inner">
      <h2>How to Play</h2>
      <ul>
        <li><b>Move:</b> Use <b>‚óÄÔ∏è</b> and <b>‚ñ∂Ô∏è</b> or tap/hold the blue controls at the bottom.</li>
        <li><b>Umbrella Power ‚òî:</b> Collect falling umbrellas for rain protection and to <span style="color:#388e3c">decrease wetness</span>.</li>
        <li>
          <b>Boost ‚ù§Ô∏è‚Äçü©π:</b> Tap the heart button in the center
          <b>OR press the <kbd>Spacebar</kbd> key</b> for <b>20s</b> spike immunity.<br>
          <span style="color:#c62828">Available every 3 minutes!</span>
        </li>
        <li><b>Levels:</b> The game gets harder! The sky color changes as you level up.</li>
        <li><b>Wetness:</b> Don't let the bar fill up. Getting too wet or hitting spikes ends the game.</li>
      </ul>
      <div class="tip">
        <b>Tip:</b> You can use the <b>Spacebar</b> key on your keyboard or tap/click the boost heart button to activate the boost!<br>
        Score and level are always visible at the top left.
      </div>
      <button id="startBtn">Start Game</button>
    </div>
  </div>
  <!-- Sounds -->
  <audio id="sfx-umbrella" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b7.mp3" preload="auto"></audio>
  <audio id="sfx-level" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b7.mp3" preload="auto"></audio>
  <audio id="sfx-spike" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b6d5d9e.mp3" preload="auto"></audio>
  <audio id="sfx-rain" src="https://upcdn.io/G22nht9/raw/mixkit-rain-and-thunder-storm-2390.wav" preload="auto" loop></audio>
  <audio id="sfx-boost" src="https://cdn.pixabay.com/audio/2022/10/16/audio_124bcf5f1b.mp3" preload="auto"></audio>
  <audio id="sfx-gameover" src="https://upcdn.io/G22nht9/raw/mixkit-arcade-retro-game-over-213.wav" preload="auto"></audio>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      // --- GAME STATE ---
      const skyColors = [["#90caf9","#e0f7fa"],["#b39ddb","#ffe082"],["#f8bbd0","#b3e5fc"],["#ffd54f","#b2ebf2"],["#c8e6c9","#b3e5fc"],["#ffccbc","#ffe082"],["#b3e5fc","#f8bbd0"]];
      let skyColorIdx = 0, level = 1, nextLevelScore = 22.5, levelUpNotice = 0, playerEmoji = "üï¥Ô∏è";
      let umbrellaActive = false, umbrellaTimer = 0, umbrellaDuration = 400;
      let boostAvailable = true, boostActive = false, boostTimer = 0, boostDuration = 1200, boostCooldown = 60*60*3, boostCooldownTimer = 0, boostJustActivated = false;
      let score = 0, gameOver = false, paused = false, started = false, rainSoundPlaying = false, gameOverSoundPlayed = false;
      let touchLeft = false, touchRight = false;
      const keys = {};
      let _player = { x: 0, y: 0, w: 0, h: 0, speed: 0, wet: 0 };
      const obstacles = [], rainDrops = [], umbrellaPowerups = [];
      // --- DOM ---
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');
      const scoreLevel = document.getElementById('score-level');
      const boostIndicator = document.getElementById('boost-indicator');
      const umbrellaIndicator = document.getElementById('umbrella-indicator');
      const ctrlLeft = document.getElementById('ctrlLeft'), ctrlRight = document.getElementById('ctrlRight'), ctrlBoost = document.getElementById('ctrlBoost');
      const restartBtn = document.getElementById('restartBtn'), pauseBtn = document.getElementById('pauseBtn');
      const instructionsDiv = document.getElementById('instructions'), startBtn = document.getElementById('startBtn');
      // Sounds
      const sfxUmbrella = document.getElementById('sfx-umbrella');
      const sfxLevel = document.getElementById('sfx-level');
      const sfxSpike = document.getElementById('sfx-spike');
      const sfxRain = document.getElementById('sfx-rain');
      const sfxBoost = document.getElementById('sfx-boost');
      const sfxGameover = document.getElementById('sfx-gameover');
      // --- RESIZE ---
      function W(){return canvas.width;}
      function H(){return canvas.height;}
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      // --- PLAYER ---
      function getPlayer() {
        return {
          x: _player.x,
          y: Math.max(0, H() - _player.h - (H()*0.28)),
          w: _player.w,
          h: _player.h,
          speed: _player.speed,
          wet: _player.wet
        };
      }
      function resetPlayer() {
        _player.w = W()*0.13;
        _player.h = H()*0.13;
        _player.x = W()/2 - _player.w/2;
        _player.speed = W()*0.012 + 2 + (level-1)*0.3;
        _player.wet = 0;
      }
      // --- CLOUDS ---
      let bgClouds = [];
      function genClouds() {
        bgClouds = [];
        for(let i=0;i<5;i++) {
          bgClouds.push({
            x: Math.random()*W(),
            y: Math.random()*H()*0.5,
            w: W()*0.25+Math.random()*W()*0.12,
            h: H()*0.11+Math.random()*H()*0.06,
            speed: 0.12 + Math.random()*0.12
          });
        }
      }
      // --- DRAW ---
      function drawBackground() {
        const idx = skyColorIdx % skyColors.length;
        const grad = ctx.createLinearGradient(0,0,0,H());
        grad.addColorStop(0, skyColors[idx][0]);
        grad.addColorStop(1, skyColors[idx][1]);
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,W(),H());
        ctx.globalAlpha = 0.6;
        for (let c of bgClouds) {
          ctx.beginPath();
          ctx.ellipse(c.x, c.y, c.w, c.h, 0, 0, Math.PI*2);
          ctx.fillStyle = "#fff";
          ctx.fill();
          c.x += c.speed;
          if (c.x-c.w>W()) {
            c.x = -c.w;
            c.y = Math.random()*H()*0.4;
          }
        }
        ctx.globalAlpha = 1;
      }
      function drawPlayer() {
        const player = getPlayer();
        ctx.font = `bold ${player.h*1.1}px serif`;
        ctx.textAlign = 'center';
        ctx.globalAlpha = 0.98;
        ctx.lineWidth = 7;
        ctx.strokeStyle = "#fff";
        ctx.strokeText(playerEmoji, player.x+player.w/2, player.y+player.h*0.93);
        ctx.lineWidth = 1;
        ctx.globalAlpha = 1;
        ctx.font = `bold ${player.h*1.05}px serif`;
        ctx.fillStyle = "#222";
        ctx.fillText(playerEmoji, player.x+player.w/2, player.y+player.h*0.93);
        ctx.globalAlpha = 1;
        if (umbrellaActive) {
          ctx.font = `bold ${player.w*0.8}px serif`;
          ctx.textAlign = 'center';
          ctx.globalAlpha = 0.95;
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 6;
          ctx.strokeText("‚òî", player.x+player.w/2, player.y-player.h*0.25);
          ctx.lineWidth = 1;
          ctx.fillStyle = "#1976d2";
          ctx.fillText("‚òî", player.x+player.w/2, player.y-player.h*0.25);
          ctx.globalAlpha = 1;
        }
        if (boostActive) {
          ctx.save();
          ctx.globalAlpha = 0.21;
          ctx.beginPath();
          ctx.arc(player.x+player.w/2, player.y+player.h/2, Math.max(player.h,player.w)*0.8, 0, Math.PI*2);
          ctx.fillStyle = "#c62828";
          ctx.fill();
          ctx.globalAlpha = 1;
          ctx.restore();
        }
      }
      // --- GAME LOGIC ---
      function playSFX(audio){try{audio.currentTime=0;audio.play();}catch(e){}}
      function rectsCollide(a, b) {
        return (a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y);
      }
      function spawnObstacle() {
        if (started && !paused && !gameOver && Math.random() < (0.015+level*0.003)) {
          const w = W()*0.13, h = H()*0.08 * 0.2;
          obstacles.push({
            x: Math.random()*(W()-w), y: -h, w, h,
            speed: 3+Math.random()*2.7+level*0.5
          });
        }
      }
      // --- SPIKE DRAW (REDUCED BY 1/4) ---
      function drawSpike(x, y, w, h) {
        // Reduce width and height of spike by 1/4 each (show 3/4 of original)
        const reducedW = w * 0.75;
        const reducedH = h * 0.75;
        const offsetX = x + (w - reducedW) / 2;
        const offsetY = y + (h - reducedH);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY + reducedH);
        for (let i = 0; i <= 5; i++) {
          let px = offsetX + (reducedW / 5) * i;
          let py = i % 2 === 0 ? offsetY + reducedH : offsetY;
          ctx.lineTo(px, py);
        }
        ctx.lineTo(offsetX + reducedW, offsetY + reducedH);
        ctx.closePath();
        ctx.fillStyle = "#c62828";
        ctx.strokeStyle = "#780000";
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();
        ctx.restore();
        ctx.lineWidth = 1;
      }
      function moveAndDrawObstacles() {
        const player = getPlayer();
        for (let i=obstacles.length-1; i>=0; i--) {
          let o = obstacles[i];
          o.y += o.speed;
          drawSpike(o.x, o.y, o.w, o.h);
          if (rectsCollide(player, o)) {
            if (boostActive) {
              obstacles.splice(i,1);
              if (!boostJustActivated) playSFX(sfxBoost);
            } else {
              if (!gameOver) playSFX(sfxSpike);
              gameOver = true;
            }
          }
          if (o.y > H()) {
            obstacles.splice(i,1);
            score++;
          }
        }
      }
      function spawnRain() {
        if (started && !paused && !gameOver && Math.random() < (0.18+0.03*level)) {
          const w = W()*0.015, h = H()*0.025;
          rainDrops.push({
            x: Math.random()*W(), y: -h, w, h,
            speed: 8+Math.random()*2+level*0.5
          });
        }
      }
      function moveAndDrawRain() {
        const player = getPlayer();
        ctx.fillStyle = "#2196f3";
        for (let i=rainDrops.length-1; i>=0; i--) {
          let r = rainDrops[i];
          r.y += r.speed;
          ctx.save();
          ctx.beginPath();
          ctx.ellipse(r.x+r.w/2, r.y+r.h/2, r.w/2, r.h/2, 0, 0, Math.PI*2);
          ctx.fillStyle = "#2196f3";
          ctx.globalAlpha = 0.8;
          ctx.fill();
          ctx.globalAlpha = 1;
          ctx.restore();
          if (rectsCollide(r, player)) {
            if (!umbrellaActive) {
              _player.wet++;
              if (!gameOver) playSFX(sfxRain);
            }
            rainDrops.splice(i,1);
            if (_player.wet > 20) gameOver = true;
          } else if (r.y > H()) {
            rainDrops.splice(i,1);
          }
        }
      }
      function spawnUmbrellaPowerup() {
        if (started && !paused && !gameOver && !umbrellaActive && umbrellaPowerups.length < 2 && Math.random()<0.04+level*0.005) {
          const w = W()*0.09, h = H()*0.09;
          umbrellaPowerups.push({
            x: Math.random()*(W()-w), y: -h, w, h,
            speed: 3+Math.random()*2+level*0.3
          });
        }
      }
      function moveAndDrawUmbrellaPowerups() {
        const player = getPlayer();
        for (let i=umbrellaPowerups.length-1; i>=0; i--) {
          let u = umbrellaPowerups[i];
          u.y += u.speed;
          ctx.font = `bold ${u.w}px serif`;
          ctx.globalAlpha = 0.95;
          ctx.textAlign = "center";
          ctx.lineWidth = 7;
          ctx.strokeStyle = "#fff";
          ctx.strokeText("‚òî", u.x+u.w/2, u.y+u.h*0.7);
          ctx.lineWidth = 1;
          ctx.globalAlpha = 1;
          ctx.fillStyle = "#1976d2";
          ctx.fillText("‚òî", u.x+u.w/2, u.y+u.h*0.7);
          ctx.globalAlpha = 1;
          if (rectsCollide(player, u)) {
            umbrellaPowerups.splice(i,1);
            activateUmbrella();
          } else if (u.y > H()) {
            umbrellaPowerups.splice(i,1);
          }
        }
      }
      function activateUmbrella() {
        umbrellaActive = true;
        umbrellaTimer = umbrellaDuration;
        umbrellaIndicator.style.display = "block";
        playSFX(sfxUmbrella);
      }
      function updateUmbrellaTimer() {
        if (umbrellaActive) {
          umbrellaTimer--;
          if (umbrellaTimer <= 0) {
            umbrellaActive = false;
            umbrellaIndicator.style.display = "none";
          }
        }
      }
      function activateBoost() {
        if (!started || !boostAvailable || boostActive || boostCooldownTimer>0) return;
        boostActive = true;
        boostAvailable = false;
        boostTimer = boostDuration;
        boostCooldownTimer = boostCooldown;
        boostIndicator.style.display = "block";
        boostJustActivated = true;
        setTimeout(()=>{boostJustActivated=false;}, 500);
        playSFX(sfxBoost);
      }
      function updateBoostTimers() {
        if (boostActive) {
          boostTimer--;
          if (boostTimer <= 0) {
            boostActive = false;
            boostIndicator.style.display = "none";
          }
        }
        if (!boostAvailable) {
          boostCooldownTimer--;
          if (boostCooldownTimer <= 0) {
            boostAvailable = true;
          }
        }
        if (boostActive) {
          boostIndicator.style.display = "block";
          boostIndicator.innerHTML = `‚ù§Ô∏è‚Äçü©π Boost! ${(boostTimer/60|0)+1}s`;
        } else if (!boostAvailable) {
          boostIndicator.style.display = "block";
          boostIndicator.innerHTML = `‚ù§Ô∏è‚Äçü©π Wait ${(boostCooldownTimer/60|0)+1}s`;
        } else {
          boostIndicator.style.display = "none";
        }
      }
      function drawScoreAndLevel() {
        if (levelUpNotice > 0) {
          ctx.save();
          ctx.globalAlpha = Math.min(1, levelUpNotice/60);
          ctx.font = "bold "+(W()*0.13|0)+"px Arial";
          ctx.fillStyle = "#388e3c";
          ctx.textAlign = "center";
          ctx.fillText("Level Up!", W()/2, H()/2-50);
          ctx.restore();
          levelUpNotice--;
        }
      }
      function updateLevel() {
        if (score >= nextLevelScore) {
          level++;
          skyColorIdx++;
          nextLevelScore += 15 * 1.5 + level * 7.5;
          playSFX(sfxLevel);
          levelUpNotice = 90;
          genClouds();
        }
      }
      function updateScoreLevelBox() {
        scoreLevel.innerHTML = `<b>Score:</b> ${score} <br/><b>Level:</b> ${level}`;
      }
      function updateWetnessBar() {
        const fill = document.getElementById('wetness-bar-fill');
        const wet = Math.min(20, Math.max(0, _player.wet));
        fill.style.width = (wet*5) + '%';
        if (wet <= 8) fill.style.background = 'linear-gradient(90deg,#2196f3 0%,#1976d2 100%)';
        else if (wet <= 15) fill.style.background = 'linear-gradient(90deg,#ffd600 0%,#ff9800 100%)';
        else fill.style.background = 'linear-gradient(90deg,#d32f2f 0%,#c62828 100%)';
      }
      function update() {
        // Always draw player and background, even before game starts
        // Only run gameplay logic if started && !paused && !gameOver
        let doGame = started && !paused && !gameOver;
        let move = 0;
        if (keys["ArrowLeft"] || touchLeft) move -= 1;
        if (keys["ArrowRight"] || touchRight) move += 1;
        if (doGame) {
          _player.x += move * _player.speed;
          _player.x = Math.max(0, Math.min(W()-_player.w, _player.x));
          umbrellaActive = !!(umbrellaActive || keys["Space"]);
          umbrellaIndicator.style.display = umbrellaActive ? "block" : "none";
          updateUmbrellaTimer();
          updateBoostTimers();
          if (umbrellaActive && _player.wet > 0 && Date.now()%3===0) {
            _player.wet -= 1;
            if (_player.wet < 0) _player.wet = 0;
          }
          if (!rainSoundPlaying) {
            try { sfxRain.volume=0.28; sfxRain.play(); rainSoundPlaying=true; } catch(e){}
          }
          spawnObstacle();
          spawnRain();
          spawnUmbrellaPowerup();
          moveAndDrawObstacles();
          moveAndDrawRain();
          moveAndDrawUmbrellaPowerups();
          updateLevel();
        }
        drawPlayer();
        updateWetnessBar();
        drawScoreAndLevel();
        updateScoreLevelBox();
      }
      function loop() {
        resizeCanvas();
        drawBackground();
        update();
        if (gameOver) {
          umbrellaIndicator.style.display = "none";
          try { sfxRain.pause(); rainSoundPlaying=false; } catch(e){}
          if (!gameOverSoundPlayed) {
            try { sfxGameover.currentTime = 0; sfxGameover.play(); } catch(e){}
            gameOverSoundPlayed = true;
          }
          ctx.fillStyle = "#fff";
          ctx.globalAlpha = 0.89;
          ctx.fillRect(0, H()/2-80, W(), 160);
          ctx.globalAlpha = 1;
          ctx.fillStyle = "#d32f2f";
          ctx.font = "bold "+(W()*0.14|0)+"px Arial";
          ctx.textAlign = "center";
          ctx.fillText("Game Over!", W()/2, H()/2-20);
          ctx.font = (W()*0.08|0)+"px Arial";
          ctx.fillStyle = "#222";
          ctx.fillText("Score: "+score, W()/2, H()/2+20);
          ctx.font = (W()*0.05|0)+"px Arial";
          ctx.fillText("Tap 'Restart' to play again!", W()/2, H()/2+50);
        } else {
          gameOverSoundPlayed = false;
        }
        requestAnimationFrame(loop); // always keep drawing!
      }
      // --- EVENTS ---
      function bindCtrl(div, on, off) {
        div.addEventListener('touchstart', e=>{div.classList.add('active');on();e.preventDefault();},{passive:false});
        div.addEventListener('touchend', e=>{div.classList.remove('active');off();e.preventDefault();},{passive:false});
        div.addEventListener('touchcancel', e=>{div.classList.remove('active');off();e.preventDefault();},{passive:false});
        div.addEventListener('mousedown', e=>{div.classList.add('active');on();e.preventDefault();});
        div.addEventListener('mouseup', e=>{div.classList.remove('active');off();e.preventDefault();});
        div.addEventListener('mouseleave', e=>{div.classList.remove('active');off();e.preventDefault();});
      }
      bindCtrl(ctrlLeft, ()=>touchLeft=true, ()=>touchLeft=false);
      bindCtrl(ctrlRight, ()=>touchRight=true, ()=>touchRight=false);
      bindCtrl(ctrlBoost,
        ()=>{
          if (!started || !boostAvailable || boostActive || boostCooldownTimer>0) return;
          activateBoost();
        },
        ()=>{}
      );
      document.addEventListener('keydown', e => {
        keys[e.code] = true;
        if (e.code==="Space" && started && !boostActive && boostAvailable && !gameOver && boostCooldownTimer<=0) activateBoost();
      });
      document.addEventListener('keyup', e => { keys[e.code] = false; });
      restartBtn.addEventListener('click', ()=>{
        resetGame();
        paused = false;
        pauseBtn.textContent = "Pause";
        if (!started) return;
      });
      pauseBtn.addEventListener('click', ()=>{
        if (!started || gameOver) return;
        paused = !paused;
        pauseBtn.textContent = paused ? "Resume" : "Pause";
      });
      startBtn.addEventListener('click', ()=>{
        instructionsDiv.style.opacity = 0;
        setTimeout(()=>{ instructionsDiv.style.display = "none"; }, 350);
        started = true;
      });
      window.addEventListener('resize', ()=>{
        resizeCanvas();
        resetPlayer();
        genClouds();
        updateScoreLevelBox();
        updateWetnessBar();
      });
      function resetGame() {
        level = 1; nextLevelScore = 22.5; levelUpNotice = 0;
        resetPlayer();
        obstacles.length = 0;
        rainDrops.length = 0;
        umbrellaPowerups.length = 0;
        score = 0;
        gameOver = false;
        umbrellaActive = false;
        umbrellaTimer = 0;
        umbrellaIndicator.style.display = "none";
        boostAvailable = true;
        boostActive = false;
        boostTimer = 0;
        boostCooldownTimer = 0;
        boostIndicator.style.display = "none";
        skyColorIdx = 0;
        genClouds();
        if (rainSoundPlaying) { try { sfxRain.pause(); rainSoundPlaying=false; } catch(e){} }
        gameOverSoundPlayed = false;
        updateScoreLevelBox();
        updateWetnessBar();
      }
      // --- INITIALIZE ---
      resizeCanvas();
      genClouds();
      resetGame();
      loop(); // always keep drawing background and player!
    });
  </script>
</body>
</html>